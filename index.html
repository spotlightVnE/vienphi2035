<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chi Tiêu Y Tế Việt Nam ‒ Mô Phỏng Chính Sách</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.276.0/dist/lucide.min.js"></script>
  <style>
    .cursor-pointer:hover { opacity: 0.8; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-green-50 min-h-screen">
  <div class="max-w-4xl mx-auto p-4 space-y-4">
    <div class="text-center space-y-4">
      <h1 class="text-4xl font-bold text-gray-800">Chi Tiêu Y Tế Việt Nam ‒ Mô Phỏng Chính Sách</h1>
      <p class="text-lg text-gray-600">Tương tác để xem tác động của các chính sách y tế mới</p>
    </div>

    <div class="grid gap-4">
      <!-- Controls -->
      <div id="controls" class="bg-white rounded-xl shadow-lg p-4">
        <div class="flex flex-wrap items-center gap-2 mb-3">
          <span class="text-sm font-medium text-gray-700">Đơn vị hiển thị:</span>
          <div id="viewModeButtons" class="flex gap-2">
            <button id="btnTrillion" class="px-3 py-1 border rounded-lg text-sm bg-white text-gray-700 border-gray-300 hover:bg-gray-50">Nghìn tỷ VND</button>
            <button id="btnUsd" class="px-3 py-1 border rounded-lg text-sm bg-blue-600 text-white border-blue-600">Tỷ USD</button>
            <button id="btnPerCapita" class="px-3 py-1 border rounded-lg text-sm bg-white text-gray-700 border-gray-300 hover:bg-gray-50">Triệu VND/người</button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
          <!-- Yearly Checkup Block -->
          <div class="space-y-1">
            <label class="flex items-center space-x-3">
              <input type="checkbox" id="chkYearly" class="h-4 w-4 text-blue-600 rounded border-gray-300" />
              <span class="text-sm font-medium text-gray-700">Thêm khám định kỳ toàn dân (+25 NkT)</span>
            </label>
            <!-- No slider or marks for this block -->
            <div class="flex justify-between h-0"></div>
          </div>
          <!-- BHYT Slider Block -->
          <div class="space-y-1">
            <label for="bhytSlider" class="block text-sm font-medium text-gray-700">
              Tỷ lệ đóng BHYT: <span id="bhytLabel">4.5%</span>
            </label>
            <input type="range" id="bhytSlider" min="0" max="10" step="0.1" value="4.5"
              class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" />
          </div>
          <!-- OOP Slider Block -->
          <div class="space-y-1">
            <label class="block text-sm font-medium text-gray-700">Giảm chi tiêu OOP (sau BHYT): <span id="oopLabel">0%</span></label>
            <input type="range" id="oopSlider" min="0" max="100" step="5" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" />
          </div>
        </div>
        <div class="border-t pt-2 mt-1">
          <h3 class="text-md font-semibold text-gray-700 mb-2">Kịch Bản Chính Sách Nhanh:</h3>
          <div class="flex flex-wrap gap-2">
            <button id="btnScenarioFreeTreatment" class="text-xs flex-1 min-w-[120px] px-1 py-0.5 rounded-lg border bg-green-500 text-white transition-colors">
                Miễn phí KCB
            </button>
            <button id="btnScenarioFreeFull" class="text-xs flex-1 min-w-[120px] px-1 py-0.5 rounded-lg border bg-sky-500 text-white transition-colors">
                Miễn phí KCB, Thuốc, DCTT
            </button>
            <button id="btnResetPolicies" class="text-xs flex-1 min-w-[120px] px-1 py-0.5 rounded-lg border bg-gray-200 text-gray-700 transition-colors">
                Reset Chính Sách
            </button>
          </div>
        </div>
      </div>
      <!-- Impact summary removed -->
      <div class="bg-white rounded-xl shadow-lg p-4 mt-4">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Tác Động Chính Sách Dự Kiến</h3>
        <div class="flex flex-col md:flex-row gap-4">
          <!-- OOP Change Block -->
          <div class="flex-1 bg-[#A9234E] text-white rounded-lg p-4 text-center">
            <div id="deltaOopValue" class="text-2xl font-bold">--</div>
            <div id="deltaOopPct" class="text-sm opacity-75">(--%)</div>
            <div class="text-sm mt-1">Thay đổi OOP</div>
          </div>
          <!-- Government Change Block -->
          <div class="flex-1 bg-[#314057] text-white rounded-lg p-4 text-center">
            <div id="deltaGovValue" class="text-2xl font-bold">--</div>
            <div id="deltaGovPct" class="text-sm opacity-75">(--%)</div>
            <div class="text-sm mt-1">Thay đổi chi tiêu NSNN</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chart and legend in a single white block, side-by-side on desktop, stacked on mobile -->
    <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">Cơ Cấu Chi Tiêu Y Tế (<span id="unitLabel">tỷ USD</span>)</h2>
    <div class="bg-white rounded-xl shadow-lg p-4">
      <div class="grid grid-cols-1 lg:grid-cols-[350px_1fr] gap-4 items-start">
        <div class="flex justify-center items-center">
          <svg id="sunburstSvg" width="350" height="350" class="mx-auto overflow-visible"></svg>
        </div>
        <div>
          <div id="legendCombined" class="p-2">
            <h3 class="font-semibold text-gray-800 mb-3">Chi Tiết Chi Tiêu</h3>
          <div id="legendCombinedContent" class="text-sm w-full"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    let tooltipDiv = null;
    function createTooltip() { tooltipDiv = document.createElement('div'); tooltipDiv.style.position = 'absolute'; tooltipDiv.style.pointerEvents = 'none'; tooltipDiv.style.backgroundColor = 'rgba(50,50,50,0.8)'; tooltipDiv.style.color = '#fff'; tooltipDiv.style.padding = '6px 10px'; tooltipDiv.style.borderRadius = '4px'; tooltipDiv.style.fontSize = '12px'; tooltipDiv.style.lineHeight = '1.2em'; tooltipDiv.style.visibility = 'hidden'; tooltipDiv.style.zIndex = '1000'; tooltipDiv.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)'; document.body.appendChild(tooltipDiv); }
    function showTooltip(html, pageX, pageY) { if (!tooltipDiv) createTooltip(); tooltipDiv.innerHTML = html; tooltipDiv.style.top = (pageY - 10) + 'px'; tooltipDiv.style.left = (pageX + 10) + 'px'; tooltipDiv.style.visibility = 'visible'; }
    function moveTooltip(pageX, pageY) { if (!tooltipDiv) return; tooltipDiv.style.top = (pageY - 10) + 'px'; tooltipDiv.style.left = (pageX + 10) + 'px'; }
    function hideTooltip() { if (!tooltipDiv) return; tooltipDiv.style.visibility = 'hidden'; }

    const POPULATION_MILLION = 98.2;
    const VND_PER_USD = 23500;

    const baseData = { // All values in nghìn tỷ VND
      outOfPocket: 173.3,
      treatment: 81.1, 
      medicine: 50.0,  
      voluntaryInsurancePurchase: 34.4, 
      medicalEquipment: 7.6,    
      
      foreignAid: 7.0,
      voluntaryHealthInsuranceFund: 24.1, 
      otherHealthcareSpending: 38.6,   
    };

    const govSplit = {
      bhyt_at_4_5_percent: 112.6, 
      directTransfer: 82.8 
    };
    const baseTotalGovernment2022 = govSplit.bhyt_at_4_5_percent + govSplit.directTransfer; 

    const defaultState = {
      viewMode: 'usd',
      addYearlyCheckup: false,
      oopReduction: 0, 
      bhytRate: 4.5    
    };
    let state = { ...defaultState };
    let computedData = null;

    function formatValue(valueTrillionVND, decimals = 1) {
      if (isNaN(valueTrillionVND) || valueTrillionVND === null) return 'N/A';
      switch (state.viewMode) {
        case 'usd': return ((valueTrillionVND * 1000) / VND_PER_USD).toFixed(decimals);
        case 'perCapita': return ((valueTrillionVND * 1e12) / (POPULATION_MILLION * 1e6) / 1e6).toFixed(decimals > 1 ? decimals : 2);
        default: return valueTrillionVND.toFixed(decimals);
      }
    }
    function getUnitLabel() {
      switch (state.viewMode) {
        case 'usd': return 'tỷ USD';
        case 'perCapita': return 'triệu VND/người';
        default: return 'nghìn tỷ VND';
      }
    }

    function computeAllData() {
      const d = {
        foreignAid: baseData.foreignAid,
        voluntaryHealthInsuranceFund: baseData.voluntaryHealthInsuranceFund,
        otherHealthcareSpending: baseData.otherHealthcareSpending,
      };

      // 1. BHYT Fund Calculation
      d.government_bhyt = govSplit.bhyt_at_4_5_percent * (state.bhytRate / 4.5);
      const bhyt_fund_change_from_baseline = d.government_bhyt - govSplit.bhyt_at_4_5_percent;

      // 2. OOP affected by BHYT change
      let oop_after_bhyt_effect = baseData.outOfPocket - bhyt_fund_change_from_baseline;
      oop_after_bhyt_effect = Math.max(0, oop_after_bhyt_effect); 

      d.oop_reduction_due_to_bhyt_increase = Math.max(0, baseData.outOfPocket - oop_after_bhyt_effect);
      d.oop_increase_due_to_bhyt_decrease = Math.max(0, oop_after_bhyt_effect - baseData.outOfPocket);

      // 3. OOP Slider applies to this new OOP baseline (oop_after_bhyt_effect)
      const oop_reduction_target_by_slider = oop_after_bhyt_effect * (state.oopReduction / 100);
      d.gov_compensation_for_oop_slider = oop_reduction_target_by_slider; 
      
      d.outOfPocket = Math.max(0, oop_after_bhyt_effect - oop_reduction_target_by_slider);

      // 4. Government Direct Transfer
      const yearly_checkup_cost = state.addYearlyCheckup ? 25 : 0;
      d.government_direct_transfer = govSplit.directTransfer + yearly_checkup_cost + d.gov_compensation_for_oop_slider;
      
      // 5. Totals
      d.government_total = d.government_bhyt + d.government_direct_transfer;
      d.other_funding_total = d.foreignAid + d.voluntaryHealthInsuranceFund + d.otherHealthcareSpending;
      d.total = d.government_total + d.outOfPocket + d.other_funding_total;

      // 6. OOP Breakdown Scaling
      const final_oop_scale_factor = (baseData.outOfPocket > 0) ? (d.outOfPocket / baseData.outOfPocket) : 0;
      d.treatment = baseData.treatment * final_oop_scale_factor;
      d.medicine = baseData.medicine * final_oop_scale_factor;
      d.voluntaryInsurancePurchase = baseData.voluntaryInsurancePurchase * final_oop_scale_factor;
      d.medicalEquipment = baseData.medicalEquipment * final_oop_scale_factor;

      const sunburstData = [
        { name: 'Chi tiêu chính phủ', value: d.government_total, color: '#314057', breakdownKey: 'govBreakdown' },
        { name: 'Tiền túi cá nhân', value: d.outOfPocket, color: '#A9234E', breakdownKey: 'oopBreakdown' },
        { name: 'Nguồn tài trợ khác', value: d.other_funding_total, color: '#9fcddc', breakdownKey: 'otherSourcesBreakdown' }
      ];
      
      let currentAngle = 0;
      const spacingDeg = 2; // 2 degrees gap between parent segments
      const totalSpacing = spacingDeg * (sunburstData.length);
      const availableAngle = 360 - totalSpacing;
      sunburstData.forEach(item => {
        item.percentage = d.total > 0 ? ((item.value / d.total) * 100).toFixed(1) : '0.0';
        const angleSpan = d.total > 0 ? (item.value / d.total) * availableAngle : 0;
        item.startAngle = currentAngle;
        item.endAngle = currentAngle + angleSpan;
        currentAngle += angleSpan + spacingDeg;
      });

      const govBreakdown = [
        { name: 'Quỹ BHYT', value: d.government_bhyt, color: '#51586D' },
        { name: 'Chuyển giao trực tiếp', value: d.government_direct_transfer, color: '#9798a6' }
      ];
      const oopBreakdown = [
        { name: 'Khám chữa bệnh', value: d.treatment, color: '#a3525b' },
        { name: 'Thuốc tự chữa & dự phòng', value: d.medicine, color: '#B55B65' },
        { name: 'Mua bảo hiểm tự nguyện', value: d.voluntaryInsurancePurchase, color: '#C37e81' },
        { name: 'Dụng cụ y tế', value: d.medicalEquipment, color: '#d2a2a3' }
      ];
      const otherSourcesBreakdown = [
        { name: 'Quỹ BHXH/BHTN', value: d.voluntaryHealthInsuranceFund, color: '#c0dce7' },
        { name: 'Viện trợ quốc tế', value: d.foreignAid, color: '#cfe4ec' },
        { name: 'Các nguồn chi khác', value: d.otherHealthcareSpending, color: '#b1d5e2' }
      ];
      
      [govBreakdown, oopBreakdown, otherSourcesBreakdown].forEach((breakdown, index) => {
        const parentSlice = sunburstData[index];
        if (!parentSlice || parentSlice.value <= 0.001 && !(parentSlice.name === 'Tiền túi cá nhân' && parentSlice.value === 0) ) return;
        let subCurrentAngle = parentSlice.startAngle;
        const parentAngleSpan = parentSlice.endAngle - parentSlice.startAngle;
        const parentValue = parentSlice.value;

        breakdown.forEach(item => {
          item.percentage = parentValue > 0 ? ((item.value / parentValue) * 100).toFixed(1) : (item.value === 0 ? '0.0' : 'N/A');
          if (parentValue < 0.001 && item.value > 0) item.percentage = '100.0';
          const angleSpan = parentValue > 0 ? (item.value / parentValue) * parentAngleSpan : (parentAngleSpan > 0 && item.value === 0 ? 0 : parentAngleSpan / (breakdown.filter(b => b.value === 0).length || 1) ); // Distribute angle if parent is 0 but children exist
          item.startAngle = subCurrentAngle; item.endAngle = subCurrentAngle + angleSpan; subCurrentAngle += angleSpan;
        });
      });
      return { raw: d, sunburstData, govBreakdown, oopBreakdown, otherSourcesBreakdown };
    }

    function drawSunburst() { 
        computedData = computeAllData();
        // Calculate and update Key Impact Cards (with values and percentages)
        const deltaOopValue = computedData.raw.outOfPocket - baseData.outOfPocket;
        // Update OOP value and percentage
        document.getElementById('deltaOopValue').textContent = formatValue(deltaOopValue) + ' ' + getUnitLabel();
        const pctOop = baseData.outOfPocket > 0 ? ((deltaOopValue / baseData.outOfPocket) * 100).toFixed(1) : '0.0';
        document.getElementById('deltaOopPct').textContent = `(${pctOop}%)`;
        // Update Government direct transfer value and percentage (new logic)
        const deltaGovValue = computedData.raw.government_direct_transfer - govSplit.directTransfer;
        document.getElementById('deltaGovValue').textContent = formatValue(deltaGovValue) + ' ' + getUnitLabel();
        const pctGov = govSplit.directTransfer > 0 ? ((deltaGovValue / govSplit.directTransfer) * 100).toFixed(1) : '0.0';
        document.getElementById('deltaGovPct').textContent = `(${pctGov}%)`;
        const svg = document.getElementById('sunburstSvg');
        while (svg.firstChild) svg.removeChild(svg.firstChild);

        const width = svg.getAttribute('width');
        const height = svg.getAttribute('height');
        const cx = width / 2;
        const cy = height / 2;
        const radiusConfig = { center: 0, ring1Inner: 50, ring1Outer: 100, ring2Outer: 150 };

        const namespace = "http://www.w3.org/2000/svg";
        const gRoot = document.createElementNS(namespace, 'g');
        gRoot.setAttribute('transform', `translate(${cx}, ${cy}) rotate(-90)`);
        svg.appendChild(gRoot);

        function toRad(deg) { return (deg * Math.PI) / 180; }

        function drawRing(segments, innerR, outerR) {
            segments.forEach(item => {
            if (item.value < 0 && !(item.name === 'Tiền túi cá nhân' && computedData.raw.outOfPocket === 0)) { // Allow OOP to be zero, but not negative for drawing
                 console.warn("Skipping draw for negative value item:", item.name, item.value);
                 return;
            }
            if (item.value <= 0.001 && !(item.name === 'Tiền túi cá nhân' && computedData.raw.outOfPocket === 0)) return;
            
            const a0 = toRad(item.startAngle); const a1 = toRad(item.endAngle);
            // Ensure a1 is greater than a0 for tiny or zero slices to avoid weird arcs
            const effectiveA1 = (item.endAngle - item.startAngle < 0.01 && item.value === 0) ? a0 + 0.01 : a1;
            const largeArc = (effectiveA1 - a0 > Math.PI) ? 1 : 0; // Use radians for largeArc check

            const x1_i = innerR * Math.cos(a0); const y1_i = innerR * Math.sin(a0);
            const x2_o = outerR * Math.cos(a0); const y2_o = outerR * Math.sin(a0);
            const x3_o = outerR * Math.cos(effectiveA1); const y3_o = outerR * Math.sin(effectiveA1);
            const x4_i = innerR * Math.cos(effectiveA1); const y4_i = innerR * Math.sin(effectiveA1);
            const pathData = `M ${x1_i} ${y1_i} L ${x2_o} ${y2_o} A ${outerR} ${outerR} 0 ${largeArc} 1 ${x3_o} ${y3_o} L ${x4_i} ${y4_i} A ${innerR} ${innerR} 0 ${largeArc} 0 ${x1_i} ${y1_i} Z`;
            
            const path = document.createElementNS(namespace, 'path');
            path.setAttribute('d', pathData);
            path.setAttribute('fill', item.color);
            path.setAttribute('stroke', 'white');
            path.setAttribute('stroke-width', '1.5'); 
            path.classList.add('cursor-pointer');
            
            const isMainRing = innerR === radiusConfig.ring1Inner;
            const tooltipText = `<strong>${item.name}</strong><br/>${formatValue(item.value)} ${getUnitLabel()}<br/>[${item.percentage}% của ${isMainRing ? 'tổng' : 'mục cha'}]`;
            path.addEventListener('mouseover', evt => { showTooltip(tooltipText, evt.pageX, evt.pageY); path.style.opacity = '0.8'; });
            path.addEventListener('mousemove', evt => moveTooltip(evt.pageX, evt.pageY));
            path.addEventListener('mouseout', () => { hideTooltip(); path.style.opacity = '1'; });
            gRoot.appendChild(path);

            const angleSpanDegrees = item.endAngle - item.startAngle;
            if (item.value > 0.01 && angleSpanDegrees > 7) { 
                const midAngleDeg = (item.startAngle + item.endAngle) / 2;
                const midAngleRad = toRad(midAngleDeg);
                const labelR = (innerR + outerR) / 2; 
                const tx = labelR * Math.cos(midAngleRad); 
                const ty = labelR * Math.sin(midAngleRad);
                
                let finalRotation = midAngleDeg;
                if (midAngleDeg > 90 && midAngleDeg < 270) { 
                    finalRotation += 180;
                }
                
                const txt = document.createElementNS(namespace, 'text');
                txt.setAttribute('x', tx); txt.setAttribute('y', ty);
                const lightColors = ['#A5F3FC', '#F1ABC1', '#67E8F9']; 
                txt.setAttribute('fill', lightColors.includes(item.color.toUpperCase()) ? '#083344' : 'white'); 
                txt.setAttribute('font-size', '9'); 
                txt.setAttribute('font-weight', 'bold');
                txt.setAttribute('text-anchor', 'middle');
                txt.setAttribute('dy', '.35em');
                txt.setAttribute('transform', `rotate(${finalRotation} ${tx} ${ty})`);
                txt.textContent = item.percentage + '%'; 
                gRoot.appendChild(txt);
            }
            });
        }

        drawRing(computedData.sunburstData, radiusConfig.ring1Inner, radiusConfig.ring1Outer);
        if (computedData.sunburstData[0]?.value > 0.001) drawRing(computedData.govBreakdown, radiusConfig.ring1Outer, radiusConfig.ring2Outer);
        if (computedData.sunburstData[1]?.value >= 0) drawRing(computedData.oopBreakdown, radiusConfig.ring1Outer, radiusConfig.ring2Outer); 
        if (computedData.sunburstData[2]?.value > 0.001) drawRing(computedData.otherSourcesBreakdown, radiusConfig.ring1Outer, radiusConfig.ring2Outer);


        const centerTextGroup = document.createElementNS(namespace, 'g');
        centerTextGroup.setAttribute('transform', `translate(${cx}, ${cy})`);
        svg.appendChild(centerTextGroup);
        const totalVal = computedData.raw.total;
        const t1 = document.createElementNS(namespace, 'text'); t1.setAttribute('x', 0); t1.setAttribute('y', -10); t1.setAttribute('text-anchor', 'middle'); t1.setAttribute('fill', '#374151'); t1.setAttribute('font-size', '14'); t1.setAttribute('font-weight', 'bold'); t1.textContent = 'Tổng Chi Tiêu'; centerTextGroup.appendChild(t1);
        const t2 = document.createElementNS(namespace, 'text'); t2.setAttribute('x', 0); t2.setAttribute('y', 10); t2.setAttribute('text-anchor', 'middle'); t2.setAttribute('fill', '#1F2937'); t2.setAttribute('font-size', '18'); t2.setAttribute('font-weight', 'bold'); t2.textContent = formatValue(totalVal); centerTextGroup.appendChild(t2);
        const t3 = document.createElementNS(namespace, 'text'); t3.setAttribute('x', 0); t3.setAttribute('y', 30); t3.setAttribute('text-anchor', 'middle'); t3.setAttribute('fill', '#6B7280'); t3.setAttribute('font-size', '12'); t3.textContent = getUnitLabel(); centerTextGroup.appendChild(t3);
        
        updateLegendsAndImpact();
    }
    

    function updateLegendsAndImpact() {
      document.getElementById('unitLabel').textContent = getUnitLabel();
      const currentUnitSuffix = " " + getUnitLabel();
      const overallTotal = computedData.raw.total; 

      // populateLegend(document.getElementById('legendMain'), computedData.sunburstData, document.getElementById('legendMain').parentElement);
      // populateLegend(document.getElementById('legendGov'), computedData.govBreakdown, document.getElementById('legendGovContainer'));
      // populateLegend(document.getElementById('legendOop'), computedData.oopBreakdown, document.getElementById('legendOopContainer'));
      // populateLegend(document.getElementById('legendOtherSources'), computedData.otherSourcesBreakdown, document.getElementById('legendOtherSourcesContainer'));

      // Build unified, 3-column legend using Tailwind table/grid classes
      const legendEl = document.getElementById('legendCombinedContent');
      legendEl.innerHTML = '';
      if (computedData && computedData.sunburstData) {
        // Create table
        const table = document.createElement('table');
        table.className = 'table-auto w-full border border-gray-300';
        // Header row
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        // Header: Tên mục
        const thName = document.createElement('th');
        thName.className = 'border border-gray-300 bg-gray-100 px-2 py-1 text-left';
        thName.textContent = 'Tên mục';
        // Header: Giá trị 2022 (nghìn tỷ)
        const thValue = document.createElement('th');
        thValue.className = 'border border-gray-300 bg-gray-100 px-2 py-1 text-center';
        thValue.textContent = 'Giá trị 2022 (nghìn tỷ)';
        // Header: % chi phí y tế (2022)
        const thPct = document.createElement('th');
        thPct.className = 'border border-gray-300 bg-gray-100 px-2 py-1 text-center';
        thPct.textContent = '% chi phí y tế (2022)';
        headerRow.append(thName, thValue, thPct);
        thead.appendChild(headerRow);
        table.appendChild(thead);
        // Body
        const tbody = document.createElement('tbody');
        computedData.sunburstData.forEach((parentItem, index) => {
          if (parentItem.value < 0) return;
          // Main row
          const tr = document.createElement('tr');
          // Name
          const tdName = document.createElement('td');
          tdName.className = 'border border-gray-300 px-2 py-1';
          const dot = document.createElement('span');
          dot.className = 'inline-block w-3 h-3 rounded mr-2 align-middle';
          dot.style.backgroundColor = parentItem.color;
          tdName.appendChild(dot);
          const nameSpan = document.createElement('span');
          nameSpan.textContent = parentItem.name;
          tdName.appendChild(nameSpan);
          // Value
          const tdVal = document.createElement('td');
          tdVal.className = 'border border-gray-300 px-2 py-1 text-center font-medium whitespace-nowrap';
          tdVal.textContent = formatValue(parentItem.value) + ' ' + getUnitLabel();
          // Percentage
          const tdPct = document.createElement('td');
          tdPct.className = 'border border-gray-300 px-2 py-1 text-center text-gray-500 text-xs whitespace-nowrap';
          tdPct.textContent = parentItem.percentage + '%';
          tr.append(tdName, tdVal, tdPct);
          tbody.appendChild(tr);
          // Subcategories
          const breakdownKey = parentItem.breakdownKey;
          const subItems = computedData[breakdownKey];
          if (subItems && subItems.length) {
            subItems.forEach(subItem => {
              if (subItem.value < 0) return;
              const subTr = document.createElement('tr');
              // Sub name
              const subTdName = document.createElement('td');
              subTdName.className = 'border border-gray-300 px-2 py-1 pl-6 text-xs';
              const subDot = document.createElement('span');
              subDot.className = 'inline-block w-2 h-2 rounded mr-2 align-middle';
              subDot.style.backgroundColor = subItem.color;
              subTdName.appendChild(subDot);
              const subNameSpan = document.createElement('span');
              subNameSpan.textContent = subItem.name;
              subTdName.appendChild(subNameSpan);
              // Sub value
              const subTdVal = document.createElement('td');
              subTdVal.className = 'border border-gray-300 px-2 py-1 text-center font-medium whitespace-nowrap text-xs';
              subTdVal.textContent = formatValue(subItem.value) + ' ' + getUnitLabel();
              // Sub percentage (relative to total CHE, not parent)
              const subTdPct = document.createElement('td');
              subTdPct.className = 'border border-gray-300 px-2 py-1 text-center text-gray-500 text-xs whitespace-nowrap';
              const totalValue = computedData.raw.total;
              subTdPct.textContent = totalValue > 0 ? ((subItem.value / totalValue) * 100).toFixed(1) + '%' : '0.0%';
              subTr.append(subTdName, subTdVal, subTdPct);
              tbody.appendChild(subTr);
            });
          }
        });
        table.appendChild(tbody);
        legendEl.appendChild(table);
      }
      
      const impact = document.getElementById('impactSummary');
      const details = document.getElementById('impactDetails');
      details.innerHTML = '';
      const isPolicyActive = state.addYearlyCheckup || state.oopReduction > 0 || state.bhytRate !== 4.5;
      // impact.classList.toggle('hidden', !isPolicyActive);

      if (isPolicyActive) {
        let scenarioGovSpending = computedData.raw.government_total;
        let impactMessages = [];

        if (state.addYearlyCheckup) {
          impactMessages.push(`✓ Khám định kỳ (+${formatValue(25)}${currentUnitSuffix}).`);
        }

        // BHYT Impact
        const bhytFundChangeRaw = computedData.raw.government_bhyt - govSplit.bhyt_at_4_5_percent;
        if (Math.abs(bhytFundChangeRaw) > 0.01) {
            let msg = `✓ Tỷ lệ BHYT ${state.bhytRate}% (Quỹ BHYT ${bhytFundChangeRaw >=0 ? '+' : ''}${formatValue(bhytFundChangeRaw)}${currentUnitSuffix}).`;
            if (computedData.raw.oop_reduction_due_to_bhyt_increase > 0.01) {
                msg += ` Giúp giảm OOP: -${formatValue(computedData.raw.oop_reduction_due_to_bhyt_increase)}${currentUnitSuffix}.`;
            } else if (computedData.raw.oop_increase_due_to_bhyt_decrease > 0.01) {
                msg += ` Làm tăng OOP: +${formatValue(computedData.raw.oop_increase_due_to_bhyt_decrease)}${currentUnitSuffix}.`;
            }
            impactMessages.push(msg);
        }

        // OOP Slider Impact
        if (state.oopReduction > 0 && computedData.raw.gov_compensation_for_oop_slider > 0.01) {
            impactMessages.push(`✓ Giảm OOP bằng NSNN (+${formatValue(computedData.raw.gov_compensation_for_oop_slider)}${currentUnitSuffix}).`);
        } else if (state.oopReduction > 0) {
            impactMessages.push(`✓ Mục tiêu giảm OOP ${state.oopReduction}% cơ bản được BHYT bù đắp hoặc đã đạt.`);
        }

        // Place up to 3 impact messages, each in a grid column
        for (let i = 0; i < 3; ++i) {
          if (impactMessages[i]) {
            details.insertAdjacentHTML('beforeend', `<div class="p-1">${impactMessages[i]}</div>`);
          } else {
            details.insertAdjacentHTML('beforeend', `<div class="p-1"></div>`);
          }
        }

        // Narrative for "Free" scenarios based on final OOP components
        const oopTreatmentCost = baseData.treatment; // 81.1 NkT
        const oopMedicineAndEquipmentCost = baseData.medicine + baseData.medicalEquipment; // 50.0 + 7.6 = 57.6 NkT

        let narrativeMsg = "";
        // Check if KCB is effectively free (remaining OOP treatment is very small)
        if (computedData.raw.treatment < 0.1) {
            if (computedData.raw.medicine < 0.1 && computedData.raw.medicalEquipment < 0.1) {
                narrativeMsg = `Kịch bản miễn phí KCB, Thuốc & DCTT: Tổng chi NSNN là <strong>${formatValue(scenarioGovSpending)}${currentUnitSuffix}</strong> (gấp ~${(scenarioGovSpending / baseTotalGovernment2022).toFixed(1)} lần năm 2022).`;
            } else {
                narrativeMsg = `Kịch bản miễn phí KCB: Tổng chi NSNN là <strong>${formatValue(scenarioGovSpending)}${currentUnitSuffix}</strong> (gấp ~${(scenarioGovSpending / baseTotalGovernment2022).toFixed(1)} lần năm 2022).`;
            }
        }

        if (narrativeMsg) {
            details.insertAdjacentHTML('beforeend', `<div class="p-1 col-span-3 mt-1 pt-1 border-t border-white/30">${narrativeMsg}</div>`);
        } else if (isPolicyActive) {
            details.insertAdjacentHTML('beforeend', `<div class="p-1 col-span-3 mt-1 pt-1 border-t border-white/30">Tổng chi NSNN hiện tại: <strong>${formatValue(scenarioGovSpending)}${currentUnitSuffix}</strong> (thay đổi ${((scenarioGovSpending / baseTotalGovernment2022 - 1) * 100).toFixed(0)}% so với 2022).</div>`);
        }
      }
    }
    
    function updateUIFromState() {
        document.getElementById('chkYearly').checked = state.addYearlyCheckup;
        document.getElementById('bhytSlider').value = state.bhytRate;
        document.getElementById('bhytLabel').textContent = state.bhytRate + "%";
        document.getElementById('oopSlider').value = state.oopReduction;
        document.getElementById('oopLabel').textContent = state.oopReduction + '%';
        // Messages for BHYT and OOP have been removed.
        drawSunburst();
    }


    document.getElementById('btnTrillion').addEventListener('click', () => { state.viewMode = 'trillion'; updateViewModeButtons(); updateUIFromState(); });
    document.getElementById('btnUsd').addEventListener('click', () => { state.viewMode = 'usd'; updateViewModeButtons(); updateUIFromState(); });
    document.getElementById('btnPerCapita').addEventListener('click', () => { state.viewMode = 'perCapita'; updateViewModeButtons(); updateUIFromState(); });
    function updateViewModeButtons() { const modes = [ { id: 'btnTrillion', mode: 'trillion' }, { id: 'btnUsd', mode: 'usd' }, { id: 'btnPerCapita', mode: 'perCapita' }]; modes.forEach(m => { const btn = document.getElementById(m.id); const isActive = state.viewMode === m.mode; btn.classList.toggle('bg-blue-600', isActive); btn.classList.toggle('text-white', isActive); btn.classList.toggle('border-blue-600', isActive); btn.classList.toggle('bg-white', !isActive); btn.classList.toggle('text-gray-700', !isActive); btn.classList.toggle('border-gray-300', !isActive); btn.classList.toggle('hover:bg-gray-50', !isActive); }); document.getElementById('unitLabel').textContent = getUnitLabel(); }

    document.getElementById('chkYearly').addEventListener('change', e => { state.addYearlyCheckup = e.target.checked; updateUIFromState(); });
document.getElementById('oopSlider').addEventListener('input', e => { state.oopReduction = Number(e.target.value); updateUIFromState(); });
document.getElementById('bhytSlider').addEventListener('input', e => {
  state.bhytRate = Number(e.target.value);
  updateUIFromState();
});
    
    document.getElementById('btnResetPolicies').addEventListener('click', () => {
        state = { ...defaultState };
        updateUIFromState();
    });

    document.getElementById('btnScenarioFreeTreatment').addEventListener('click', () => {
        state.addYearlyCheckup = true;
        // Compute new data after BHYT but before OOP slider
        const d = computeAllData().raw;
        const bhytFundChange = d.government_bhyt - govSplit.bhyt_at_4_5_percent;
        let oop_after_bhyt = Math.max(0, baseData.outOfPocket - bhytFundChange);
        // Calculate the portion of OOP allocated to treatment in current state
        const currentTreatmentOOP = baseData.treatment * (oop_after_bhyt / baseData.outOfPocket);
        // Determine slider percentage to eliminate currentTreatmentOOP
        const reductionPercent = oop_after_bhyt > 0 ? (currentTreatmentOOP / oop_after_bhyt) * 100 : 0;
        state.oopReduction = Math.min(100, Math.max(0, reductionPercent));
        state.oopReduction = Math.round(state.oopReduction / 5) * 5;
        updateUIFromState();
    });

    document.getElementById('btnScenarioFreeFull').addEventListener('click', () => {
        state.addYearlyCheckup = true;
        const d = computeAllData().raw;
        const bhytFundChange = d.government_bhyt - govSplit.bhyt_at_4_5_percent;
        let oop_after_bhyt = Math.max(0, baseData.outOfPocket - bhytFundChange);
        // Calculate total OOP for treatment, medicine, and equipment in current state
        const currentTreatmentOOP = baseData.treatment * (oop_after_bhyt / baseData.outOfPocket);
        const currentMedicineOOP = baseData.medicine * (oop_after_bhyt / baseData.outOfPocket);
        const currentEquipmentOOP = baseData.medicalEquipment * (oop_after_bhyt / baseData.outOfPocket);
        const targetReductionOOP = currentTreatmentOOP + currentMedicineOOP + currentEquipmentOOP;
        const reductionPercent = oop_after_bhyt > 0 ? (targetReductionOOP / oop_after_bhyt) * 100 : 0;
        state.oopReduction = Math.min(100, Math.max(0, reductionPercent));
        state.oopReduction = Math.round(state.oopReduction / 5) * 5;
        updateUIFromState();
    });

    updateUIFromState(); // Initial call
  </script>
</script>
<script>lucide.replace()</script>
</body>
</html>
